import os
import unittest

import numpy as np
import pandas as pd

from Signals.Signals import signal_is_volume_high_enough, signal_is52_w_high, \
    signal_is_volume_raising_within_check_days, signal_is_last_volume_higher_than_avg, signal_is_a_few_higher_than_avg, \
    signal_is_volume_raising
from Utils.common_utils import calc_avg_vol, calculate_stopbuy_and_stoploss

# from directory UnitTests to --> root folder with: ..\\..\\
ROOT_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
filepath = ROOT_DIR + '\\DataFiles\\'
test_filepath = filepath + 'TestData\\'


class MyTest(unittest.TestCase):

    def test_convert(self):
        file = test_filepath + 'test_calculate_stopbuy_and_stoploss_Ok.csv'
        data = pd.read_csv(file)
        print()
        print()

        print("labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']")
        print(" data = [")
        for i in range(0, len(data)):
            if i == len(data) - 1:
                print("(\'{0}\', {1}, {2}, {3}, {4}, {5})]".format(str(data.Date[i]), str(data.Open[i]),
                                                                   str(data.High[i]), str(data.Low[i]),
                                                                   str(data.Close[i]), str(data.Volume[i])))
            else:
                print("(\'{0}\', {1}, {2}, {3}, {4}, {5}),".format(str(data.Date[i]), str(data.Open[i]),
                                                                   str(data.High[i]), str(data.Low[i]),
                                                                   str(data.Close[i]), str(data.Volume[i])))

        print ("data = pd.DataFrame.from_records(data, columns=labels)")

    def test_isVolumeHighEnough(self):
        # volume below 15k
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 23.6, 23.73, 23.15, 23.26, 14000),
            ('2016-09-14', 23.33, 23.43, 22.95, 23.11, 14000),
            ('2016-09-15', 23.15, 23.77, 23.14, 23.62, 14000),
            ('2016-09-16', 23.57, 23.68, 23.38, 23.5, 14000),
            ('2016-09-19', 23.6, 23.77, 23.46, 23.51, 14000),
            ('2016-09-20', 23.73, 23.76, 23.26, 23.31, 14000),
            ('2016-09-21', 23.36, 23.78, 23.35, 23.73, 14000),
            ('2016-09-22', 23.83, 23.89, 23.46, 23.73, 14000),
            ('2016-09-23', 23.64, 23.82, 23.54, 23.71, 14000),
            ('2016-09-26', 23.59, 23.81, 23.51, 23.73, 14000),
            ('2016-09-27', 23.73, 23.78, 23.41, 23.72, 14000),
            ('2016-09-28', 23.73, 23.77, 23.56, 23.75, 14000),
            ('2016-09-29', 23.74, 23.82, 23.16, 23.3, 14000),
            ('2016-09-30', 23.35, 23.91, 23.24, 23.8, 14000),
            ('2016-10-03', 23.68, 23.69, 23.39, 23.5, 14000),
            ('2016-10-04', 23.52, 23.64, 23.18, 23.28, 14000),
            ('2016-10-05', 23.28, 23.51, 23.27, 23.43, 14000),
            ('2016-10-06', 23.38, 23.56, 23.29, 23.48, 14000),
            ('2016-10-07', 23.58, 23.65, 23.37, 23.48, 14000),
            ('2016-10-10', 23.62, 23.88, 23.55, 23.77, 14000),
            ('2016-10-11', 23.62, 23.74, 23.01, 23.16, 14000),
            ('2016-10-12', 23.16, 23.39, 23.11, 23.18, 14000)]
        df = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_high_enough(df), False)

        # volume above 30k
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 23.6, 23.73, 23.15, 23.26, 16000),
            ('2016-09-14', 23.33, 23.43, 22.95, 23.11, 16000),
            ('2016-09-15', 23.15, 23.77, 23.14, 23.62, 16000),
            ('2016-09-16', 23.57, 23.68, 23.38, 23.5, 16000),
            ('2016-09-19', 23.6, 23.77, 23.46, 23.51, 16000),
            ('2016-09-20', 23.73, 23.76, 23.26, 23.31, 16000),
            ('2016-09-21', 23.36, 23.78, 23.35, 23.73, 16000),
            ('2016-09-22', 23.83, 23.89, 23.46, 23.73, 16000),
            ('2016-09-23', 23.64, 23.82, 23.54, 23.71, 16000),
            ('2016-09-26', 23.59, 23.81, 23.51, 23.73, 16000),
            ('2016-09-27', 23.73, 23.78, 23.41, 23.72, 16000),
            ('2016-09-28', 23.73, 23.77, 23.56, 23.75, 16000),
            ('2016-09-29', 23.74, 23.82, 23.16, 23.3, 16000),
            ('2016-09-30', 23.35, 23.91, 23.24, 23.8, 16000),
            ('2016-10-03', 23.68, 23.69, 23.39, 23.5, 16000),
            ('2016-10-04', 23.52, 23.64, 23.18, 23.28, 16000),
            ('2016-10-05', 23.28, 23.51, 23.27, 23.43, 16000),
            ('2016-10-06', 23.38, 23.56, 23.29, 23.48, 16000),
            ('2016-10-07', 23.58, 23.65, 23.37, 23.48, 16000),
            ('2016-10-10', 23.62, 23.88, 23.55, 23.77, 16000),
            ('2016-10-11', 23.62, 23.74, 23.01, 23.16, 16000),
            ('2016-10-12', 23.16, 23.39, 23.11, 23.18, 16000)]
        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_high_enough(data), True)

    def test_is52W_High(self):
        # last val 52 w Hi: data High: curVal is 100, other 90
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 31000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 31000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 31000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 31000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 31000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 31000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 31000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 31000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 31000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 31000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 31000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 31000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 31000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 31000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 31000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 31000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 31000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 31000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 31000),
            ('2016-10-10', 90, 90, 100.55, 100.77, 31000),
            ('2016-10-11', 90, 90, 100.01, 100.16, 31000),
            ('2016-10-12', 90, 100, 100.11, 100.18, 31000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is52_w_high(data, 0.98), True)

        # last val < 0.98 hi: High: 100, lastval = 97
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 100, 100, 100.15, 100.26, 31000),
            ('2016-09-14', 100, 100, 22.95, 100.11, 31000),
            ('2016-09-15', 100, 100, 100.14, 100.62, 31000),
            ('2016-09-16', 100, 100, 100.38, 100.5, 31000),
            ('2016-09-19', 100, 100, 100.46, 100.51, 31000),
            ('2016-09-20', 100, 100, 100.26, 100.31, 31000),
            ('2016-09-21', 100, 100, 100.35, 100.73, 31000),
            ('2016-09-22', 100, 100, 100.46, 100.73, 31000),
            ('2016-09-23', 100, 100, 100.54, 100.71, 31000),
            ('2016-09-26', 100, 100, 100.51, 100.73, 31000),
            ('2016-09-27', 100, 100, 100.41, 100.72, 31000),
            ('2016-09-28', 100, 100, 100.56, 100.75, 31000),
            ('2016-09-29', 100, 100, 100.16, 100.3, 31000),
            ('2016-09-30', 100, 100, 100.24, 100.8, 31000),
            ('2016-10-03', 100, 100, 100.39, 100.5, 31000),
            ('2016-10-04', 100, 100, 100.18, 100.28, 31000),
            ('2016-10-05', 100, 100, 100.27, 100.43, 31000),
            ('2016-10-06', 100, 100, 100.29, 100.48, 31000),
            ('2016-10-07', 100, 100, 100.37, 100.48, 31000),
            ('2016-10-10', 100, 100, 100.55, 100.77, 31000),
            ('2016-10-11', 100, 100, 100.01, 100.16, 31000),
            ('2016-10-12', 100, 97, 100.11, 100.18, 31000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is52_w_high(data, 0.98), False)

        # last val > 1.03 hi: High: 100, lastval = 104
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 100, 100, 100.15, 100.26, 31000),
            ('2016-09-14', 100, 100, 22.95, 100.11, 31000),
            ('2016-09-15', 100, 100, 100.14, 100.62, 31000),
            ('2016-09-16', 100, 100, 100.38, 100.5, 31000),
            ('2016-09-19', 100, 100, 100.46, 100.51, 31000),
            ('2016-09-20', 100, 100, 100.26, 100.31, 31000),
            ('2016-09-21', 100, 100, 100.35, 100.73, 31000),
            ('2016-09-22', 100, 100, 100.46, 100.73, 31000),
            ('2016-09-23', 100, 100, 100.54, 100.71, 31000),
            ('2016-09-26', 100, 100, 100.51, 100.73, 31000),
            ('2016-09-27', 100, 100, 100.41, 100.72, 31000),
            ('2016-09-28', 100, 100, 100.56, 100.75, 31000),
            ('2016-09-29', 100, 100, 100.16, 100.3, 31000),
            ('2016-09-30', 100, 100, 100.24, 100.8, 31000),
            ('2016-10-03', 100, 100, 100.39, 100.5, 31000),
            ('2016-10-04', 100, 100, 100.18, 100.28, 31000),
            ('2016-10-05', 100, 100, 100.27, 100.43, 31000),
            ('2016-10-06', 100, 100, 100.29, 100.48, 31000),
            ('2016-10-07', 100, 100, 100.37, 100.48, 31000),
            ('2016-10-10', 100, 100, 100.55, 100.77, 31000),
            ('2016-10-11', 100, 100, 100.01, 100.16, 31000),
            ('2016-10-12', 101, 104, 101.0, 101.0, 32000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is52_w_high(data, 0.98), True)

        # last val = 99, High is 100
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 96, 100, 96.15, 96.26, 3960),
            ('2016-09-14', 96, 96, 22.95, 96.11, 3960),
            ('2016-09-15', 96, 96, 96.14, 96.62, 3960),
            ('2016-09-16', 96, 96, 96.38, 96.5, 3960),
            ('2016-09-19', 96, 96, 96.46, 96.51, 3960),
            ('2016-09-20', 96, 96, 96.26, 96.31, 3960),
            ('2016-09-21', 96, 96, 96.35, 96.73, 3960),
            ('2016-09-22', 96, 96, 96.46, 96.73, 3960),
            ('2016-09-23', 96, 96, 96.54, 96.71, 3960),
            ('2016-09-26', 96, 96, 96.51, 96.73, 3960),
            ('2016-09-27', 96, 96, 96.41, 96.72, 3960),
            ('2016-09-28', 96, 96, 96.56, 96.75, 3960),
            ('2016-09-29', 96, 96, 96.16, 96.3, 3960),
            ('2016-09-30', 96, 96, 96.24, 96.8, 3960),
            ('2016-10-03', 96, 96, 96.39, 96.5, 3960),
            ('2016-10-04', 96, 96, 96.18, 96.28, 3960),
            ('2016-10-05', 96, 96, 96.27, 96.43, 3960),
            ('2016-10-06', 96, 96, 96.29, 96.48, 3960),
            ('2016-10-07', 96, 96, 96.37, 96.48, 3960),
            ('2016-10-10', 96, 96, 96.55, 96.77, 3960),
            ('2016-10-11', 96, 96, 96.01, 96.16, 3960),
            ('2016-10-12', 96, 99, 101.0, 101.0, 32000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is52_w_high(data, 0.98), True)

    def test_t1_isVolumeRaising_withinCheckDays(self):
        # t1: minimum raising
        # h,h,h,l,h
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 5000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 6000),
            ('2016-10-11', 90, 90, 100.01, 100.16, 6000),
            ('2016-10-12', 90, 100, 100.11, 100.18, 11000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        #file = test_filepath + 'test_isVolumeRaising_2_t1_HHHLH.csv'
        self.assertEqual(signal_is_volume_raising_within_check_days(data, 5, 3), True)

        # h,h,l,l,h
        #file = test_filepath + 'test_isVolumeRaising_2_t1_HHLHH.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 5000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 6000),
            ('2016-10-10', 90, 90, 100.55, 100.77, 3000),
            ('2016-10-11', 90, 90, 100.01, 100.16, 7000),
            ('2016-10-12', 90, 100, 100.11, 100.18, 11000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_raising_within_check_days(data, 5, 3), True)

        # h,h,h,h,h
        #file = test_filepath + 'test_isVolumeRaising_2_t1_HHHH.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 5000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 6000),
            ('2016-10-10', 90, 90, 100.55, 100.77, 7000),
            ('2016-10-11', 90, 90, 100.01, 100.16, 8000),
            ('2016-10-12', 90, 100, 100.11, 100.18, 11000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_raising_within_check_days(data, 5, 3), True)

        ###########################
        # FALSE

        # t1: h, lowest, l, l, h but raising
        #file = test_filepath + 'test_isVolumeRaising_2_t1_HLowestLLL.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 5000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 2000),
            ('2016-10-10', 90, 90, 100.55, 100.77, 3000),
            ('2016-10-11', 90, 90, 100.01, 100.16, 4000),
            ('2016-10-12', 90, 100, 100.11, 100.18, 11000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_raising_within_check_days(data, 5, 3), False)

        # t1: h, l, l, l, h
        #file = test_filepath + 'test_isVolumeRaising_2_t1_HLLLH.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 3000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 3500),
            ('2016-10-10', 90, 90, 100.55, 100.77, 2300),
            ('2016-10-11', 90, 90, 100.01, 100.16, 2000),
            ('2016-10-12', 90, 100, 100.11, 100.18, 11000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_raising_within_check_days(data, 5, 3), False)

    def test_t2_isLastVolumeHigherThanAvg(self):
        # t2: last 4k8, avg 4k --> below
        #file = test_filepath + 'test_t2_isLastVolumeHigherThanAvg_belowAvg4k_last3k8.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 4000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 4000),
            ('2016-10-10', 90, 90, 100.55, 100.77, 4000),
            ('2016-10-11', 90, 90, 100.01, 100.16, 4000),
            ('2016-10-12', 90, 100, 100.11, 100.18, 3800)]

        data = pd.DataFrame.from_records(data, columns=labels)
        vol_avg = calc_avg_vol(data)
        self.assertEqual(signal_is_last_volume_higher_than_avg(data, vol_avg, 1.2), False)

        # t2: above avg 4k2
        #file = test_filepath + 'test_t2_isLastVolumeHigherThanAvg_belowAvg4k_last5k2.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 4000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 4000),
            ('2016-10-10', 90, 90, 100.55, 100.77, 4000),
            ('2016-10-11', 90, 90, 100.01, 100.16, 4000),
            ('2016-10-12', 90, 100, 100.11, 100.18, 5200)]

        data = pd.DataFrame.from_records(data, columns=labels)
        vol_avg = calc_avg_vol(data)
        self.assertEqual(signal_is_last_volume_higher_than_avg(data, vol_avg, 1.2), True)

    def test_t3_is_a_few_higher_than_avg(self):
        # T3: higher than avg
        #file = test_filepath + 'test_t3_is_a_few_higher_than_avg_AreHigher.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 4000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 4700),
            ('2016-10-10', 90, 90, 100.55, 100.77, 4800),
            ('2016-10-11', 90, 90, 100.01, 100.16, 4900),
            ('2016-10-12', 90, 100, 100.11, 100.18, 5000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        vol_avg = calc_avg_vol(data)
        self.assertEqual(signal_is_a_few_higher_than_avg(data, 5, 3, vol_avg), True)

        # T3: LOWER than avg
        #file = test_filepath + 'test_t3_is_a_few_higher_than_avg_AreLower.csv'

        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 4500),
            ('2016-10-07', 90, 90, 100.37, 100.48, 3200),
            ('2016-10-10', 90, 90, 100.55, 100.77, 3800),
            ('2016-10-11', 90, 90, 100.01, 100.16, 2900),
            ('2016-10-12', 90, 100, 100.11, 100.18, 5000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        vol_avg = calc_avg_vol(data)
        self.assertEqual(signal_is_a_few_higher_than_avg(data, 5, 3, vol_avg), False)

    def test_isVolumeRaising_2(self):
        # True
        #file = test_filepath + 'test_isVolumeRaising_2_True.csv'

        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 5000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 6000),
            ('2016-10-10', 90, 90, 100.55, 100.77, 7000),
            ('2016-10-11', 90, 90, 100.01, 100.16, 8000),
            ('2016-10-12', 90, 100, 100.11, 100.18, 11000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_raising(data, 5, 3, 1.2), True)

        # False t1: volume not raising
        #file = test_filepath + 'test_isVolumeRaising_2_False_T1.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 5000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 4900),
            ('2016-10-10', 90, 90, 100.55, 100.77, 4800),
            ('2016-10-11', 90, 90, 100.01, 100.16, 4750),
            ('2016-10-12', 90, 100, 100.11, 100.18, 4850)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_raising(data, 5, 3, 1.2), False)

        # False t2: last vol not higher than avg
        #file = test_filepath + 'test_isVolumeRaising_2_False_T2.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 5000),
            ('2016-10-07', 90, 90, 100.37, 100.48, 6000),
            ('2016-10-10', 90, 90, 100.55, 100.77, 6500),
            ('2016-10-11', 90, 90, 100.01, 100.16, 6750),
            ('2016-10-12', 90, 100, 100.11, 100.18, 3800)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_raising(data, 5, 3, 1.2), False)

        # False t3: at least NOT a few volume higher than avg
        #file = test_filepath + 'test_isVolumeRaising_2_False_T3.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-09-13', 90, 90, 100.15, 100.26, 4000),
            ('2016-09-14', 90, 90, 22.95, 100.11, 4000),
            ('2016-09-15', 90, 90, 100.14, 100.62, 4000),
            ('2016-09-16', 90, 90, 100.38, 100.5, 4000),
            ('2016-09-19', 90, 90, 100.46, 100.51, 4000),
            ('2016-09-20', 90, 90, 100.26, 100.31, 4000),
            ('2016-09-21', 90, 90, 100.35, 100.73, 4000),
            ('2016-09-22', 90, 90, 100.46, 100.73, 4000),
            ('2016-09-23', 90, 90, 100.54, 100.71, 4000),
            ('2016-09-26', 90, 90, 100.51, 100.73, 4000),
            ('2016-09-27', 90, 90, 100.41, 100.72, 4000),
            ('2016-09-28', 90, 90, 100.56, 100.75, 4000),
            ('2016-09-29', 90, 90, 100.16, 100.3, 4000),
            ('2016-09-30', 90, 90, 100.24, 100.8, 4000),
            ('2016-10-03', 90, 90, 100.39, 100.5, 4000),
            ('2016-10-04', 90, 90, 100.18, 100.28, 4000),
            ('2016-10-05', 90, 90, 100.27, 100.43, 4000),
            ('2016-10-06', 90, 90, 100.29, 100.48, 3400),
            ('2016-10-07', 90, 90, 100.37, 100.48, 3600),
            ('2016-10-10', 90, 90, 100.55, 100.77, 3700),
            ('2016-10-11', 90, 90, 100.01, 100.16, 3750),
            ('2016-10-12', 90, 100, 100.11, 100.18, 6800)]

        data = pd.DataFrame.from_records(data, columns=labels)
        self.assertEqual(signal_is_volume_raising(data, 5, 3, 1.2), False)

    def test_calculate_stopbuy_and_stoploss(self):
        #file = test_filepath + 'test_calculate_stopbuy_and_stoploss_Ok.csv'
        labels = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
        data = [
            ('2016-10-07', 23.58, 23.65, 23.37, 23.48, 43000),
            ('2016-10-10', 23.62, 23.88, 23.55, 24.0, 44000),
            ('2016-10-11', 23.62, 30.0, 23.01, 23.16, 45000),
            ('2016-10-12', 23.16, 23.0, 23.11, 23.5, 46000)]

        data = pd.DataFrame.from_records(data, columns=labels)
        res = calculate_stopbuy_and_stoploss(data)
        # previous calculation with latest value should now be false
        self.assertEqual(np.math.isclose(res['sb'], 23.6175, abs_tol=0.001), False)  # =23,5*1.005
        self.assertEqual(np.math.isclose(res['sl'], 22.9089, abs_tol=0.001), False)  # =23,5*1.005*0.97

        # real calculation with real 52 w high value
        self.assertEqual(np.math.isclose(res['sb'], 30.15, abs_tol=0.001), True)  # =30*1.005
        self.assertEqual(np.math.isclose(res['sl'], 29.2455, abs_tol=0.001), True)  # =30*1.005*0.97

        # TODO using coverage: http://pymbook.readthedocs.io/en/latest/testing.html
        # https://blog.jetbrains.com/pycharm/2015/06/feature-spotlight-python-code-coverage-with-pycharm/
        # https://www.jetbrains.com/help/pycharm/configuring-code-coverage-measurement.html
        # https://www.jetbrains.com/help/pycharm/viewing-code-coverage-results.html


    # def test_read_current_day_from_yahoo(self):
    #
    #     names = ["ads", "ETR:GFT", "ETR:GFT", "AAPL", "AMZN"]
    #
    #     for name in names:
    #         data = read_current_day_from_yahoo(name)
    #         self.assertEqual(len(data), 1)
    #
    #     with self.assertRaises(Exception):
    #         read_current_day_from_yahoo("APPL.DE")

    # def test_read_data_from_google(self):
    #     end = datetime.now()
    #     ago52_w = (end - timedelta(weeks=52))
    #     ago2_w = (end - timedelta(weeks=2))
    #     res = read_data_from_google_with_pandas("ADBE", ago52_w, end) # 2017-09-21
    #     res = read_data_from_google_with_pandas("ADBE", ago52_w, end)  # 2017-09-210
    #     # TODO liefert immer 1 jahr
    #
    # def test_read_data_from_google_with_client(self):
    #     names = ["ads", "ETR:GFT", "ETR:GFT", "AAPL", "AMZN"]
    #
    #     for name in names:
    #         res = read_data_from_google_with_client(name)
    #         print()


    #def test_run_stock_screening_performance(self):
        # thr_start = datetime.now()
        # stocks_per_threads = 10
        # run_stock_screening(stocks_per_threads)
        # txt1 = "\nRuntime mit " + str(stocks_per_threads) +" Threads: " + str(datetime.now() - thr_start)
        #
        # thr_start = datetime.now()
        # stocks_per_threads = 5
        # run_stock_screening(stocks_per_threads)
        # txt2 = "\n\nRuntime mit " + str(stocks_per_threads) + " Threads: " + str(datetime.now() - thr_start)

        #thr_start = datetime.now()
        #stocks_per_threads = 2
        #run_stock_screening(stocks_per_threads)
        #txt3 = "\n\nRuntime mit " + str(stocks_per_threads) + " Threads: " + str(datetime.now() - thr_start)

        # print(txt1)
        # print(txt2)
        #print(txt3)
